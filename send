#!/usr/bin/env bash

# This script has been auto-generated by Jirafeau but you can still edit options below.

# Config begin
url='https://bin.spizza.cc/' # Or set JIRAFEAU_URL.
time='month' # Or set JIRAFEAU_TIME.
curl='' # Or set JIRAFEAU_CURL_PATH.
# Config end

if [ -z "$url" ]; then
    echo "Please set url in script parameters"
fi

if [ -z "$curl" ]; then
    curl="$JIRAFEAU_CURL_PATH"
fi

if [ -z "$curl" ] && [ -e "/usr/bin/curl" ]; then
    curl="/usr/bin/curl"
fi

if [ -z "$curl" ] && [ -e "/bin/curl.exe" ]; then
    curl="/bin/curl.exe"
fi

if [ -z "$curl" ]; then
    echo "Please set your curl binary path (by editing this script or export JIRAFEAU_CURL_PATH global variable)."
    exit
fi

apipage='script.php'
downloadpage='f.php'

if [ ! -f "$1" ]; then
    echo "File \"$1\" does not exists."
    exit
fi

# Ret result
res=$($curl -s -X POST --http1.0 $proxy $options \
              -F "time=$time" \
              -F "file=@$1" \
              $url$apipage)

if [[ "$res" == Error* ]]; then
    echo "Error while uploading."
    echo $res
    exit
fi

# Not using head or tail to minimise command dependencies
code=$(cnt=0; echo "$res" | while read l; do
    if [[ "$cnt" == "0" ]]; then
        echo "$l"
    fi
    cnt=$(( cnt + 1 ))
    done)
del_code=$(cnt=0; echo "$res" | while read l; do
    if [[ "$cnt" == "1" ]]; then
        echo "$l"
    fi
    cnt=$(( cnt + 1 ))
    done)
key_code=$(cnt=0; echo "$res" | while read l; do
    if [[ "$cnt" == "2" ]]; then
        echo "$l"
    fi
    cnt=$(( cnt + 1 ))
    done)

echo
if [[ $key_code ]]; then
		INTENT_URL="${url}${downloadpage}?h=$code&k=$key_code"
else
		INTENT_URL="${url}${downloadpage}?h=$code"
fi

# Variables
GOTIFY_URL="https://gotify.spizza.cc/message"  # Replace with your Gotify server URL
GOTIFY_TOKEN="A_.GzDwG63eWHva"  # Replace with your Gotify app token
HOSTNAME=$(cat /etc/hostname)  # Get the system hostname

# Construct JSON payload manually
JSON_PAYLOAD=$(cat <<EOF
{
    "title": "File Snatched",
    "message": "A file was successfully snatched from $HOSTNAME: $INTENT_URL",
    "priority": 10,
    "extras": {
        "client::notification": {
            "click": {
                "url": "$INTENT_URL"
            }
        },
        "android::action": {
            "onReceive": {
                "intentUrl": "$INTENT_URL"
            }
        }
    }
}
EOF
)

# Send the request
curl -s -o /dev/null -X POST "$GOTIFY_URL" \
    -H "Content-Type: application/json" \
    -H "X-Gotify-Key: $GOTIFY_TOKEN" \
    -d "$JSON_PAYLOAD"
